---
title: "postfixで稼働中のメールサーバーをSendGridへ移行した際の記録"
emoji: "📧"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: 
    - "mail"
    - "Gmail"
    - "SendGrid"
    - "postfix"
published: false
---

メールサービスの載せ替えをしたので、意識した事、感じた事など残しておこうと思います。
普段メール周りの監視項目などはあまり意識をせずに保守運用をしていたので、学びの多い開発になりました。
どこかで誰かの参考になれば嬉しく思います。

## 背景
昨年、Googleが発表した[メール送信者ガイドライン](https://support.google.com/a/answer/81126?hl=ja)を受け、認証まわりの見直しと、より良い運用・保守性を求めてメールサービスの変更を決定。

## 主な変更点

### これまで
- DKIM認証：[OpenDKIM](http://www.opendkim.org/)
- SPF認証 / DMARC認証：AWS Route53でのレコード設定
- メールサーバ：EC2で[Postfix](https://www.postfix.org/)を構築
- リレーサービス：ベアメール
- メール送信：CakePHPの[Mailer](https://book.cakephp.org/4/ja/core-libraries/email.html)でMTAホストへメールの送信

### これから
- SPF認証 / DKIM認証 / DMARC認証：SendGridでDomain Authenticationを設定し、AWS Route53でのレコード設定
- メール送信：[php-sdk](https://github.com/sendgrid/sendgrid-php)を利用し、SendGridの[WebAPI V3](https://sendgrid.kke.co.jp/docs/API_Reference/Web_API_v3/index.html)の実行

## 感じていた課題点

### 認証
メールサーバを管理し、MTAの構築やDKIMの認証設定を自らしていたので、アプリケーションの変更が認証結果にも影響を及ぼす可能性があり認知の必要がある。設定にも落とし穴があり、運用保守が大変。

例えばMTA側で改行コードやテンプレートの変換をしてしまい、メールハッシュ値が変わることによりDKIM認証がFAIL（body hash did not verify）となるなど。
バージョンにもよるが、[sendmail_fix_line_endings](https://www.postfix.org/postconf.5.html#sendmail_fix_line_endings)の設定等で回避しなければいけなかったりする。

また、メールは基本7bitとなるためエンコード（Content-Transfer-Encoding）にも左右される場合があったりする、等

### 構成
レピュテーションの高いIPアドレスからメールの送信がされるようにリレーサービスを利用していたが、その構成自体が冗長なものであった。メールのトラブルが発生した際にも、サービスを切り分けて調査していく必要もある。

## 導入に関して

### 開発
ドキュメントも十分に存在し、特段困ることはなかった。
基本的に以下2点を確認しておけばOK。
- [SendGrid WebAPI V3](https://docs.sendgrid.com/api-reference/how-to-use-the-sendgrid-v3-api/authentication)
- [php-sdk-usecase](https://github.com/sendgrid/sendgrid-php/blob/main/USE_CASES.md)

動的テンプレートやワンクリック解除などは独自開発していたため、その辺の機能は利用せず。
ワンクリック解除に関しては、送信時にアプリケーション側からメールヘッダを設定。

また、できればSendGrid側での開封率・クリック率測定も設定したかったものの、テキストメールに関してはクリック率を測定するのにパラメータが付与されてしまうので以下の理由から利用していない。
- アプリケーション側で独自に測定する機能があること
- リンクブランド設定をすればドメインは独自のものになるが、どうしてもパラメータ部分が長く、作成時とメール受信時の差異が違和感を覚えてしまうこと

### 移行
新規のメールサービスを立ち上げる訳ではなく載せ替えとなるため、移行に関しては以下2点を意識した。
- IPウォームアップ及びそのスケジューリング
- 送信先リストのクリーニング

#### IPウォームアップ及びそのスケジューリング
この観点を持てておらず、リリース直前で一括載せ替えのリリースから、段階的なものへとリリースの計画変更、、、😭
メールサービスの載せ替え（というより送信元IPアドレスの変更）が今後あるか分からないが、勉強になった。

スケジューリングに関しては[こちら](https://twilio-cms-prod.s3.amazonaws.com/documents/Generic_IP_Warmup_Schedule.pdf)を参考に。

多い日によっては2万通のメールを送信するプロダクトだったため、スロットリングやブロックが発生してしまうと大事故となる。
問題のない可能性もあったが、慎重になりすぎるぐらいが丁度いいと思い、分割で徐々に適用していく計画とする。

#### 送信先リストのクリーニング
こちらに関しては問題ないとし、リリース時のクリーニングは実施せず。

バウンス率に関しては3%未満を理想とし、10%到達してしまうと危険水域という認識で進めており、
現行システムでの配信エラー率が3%未満であったため、載せ替え時においてのクリーニングは実施しないという判断。
とはいえ、ソフトバウンス・ハードバウンスともにSendGridでは[独自の基準](https://sendgrid.kke.co.jp/docs/Tutorials/A_Transaction_Mail/manage_bounces.html?_gl=1*1ubwlud*_ga*NTk4NzE0MTUzLjE3MTMzNDQ3MDI.*_ga_JL4V7PSVHH*MTcxNjE5MDcyMi40NC4xLjE3MTYxOTEzNDcuMC4wLjA.*_ga_NFRNW0FC62*MTcxNjE5MDcyMi40NC4xLjE3MTYxOTEzNDcuMC4wLjA.)に基づいて振り分けられているため、移行後の変動など注視していく必要はあると感じる。（SendGridに限らずだが）

### 運用・保守（これからの話）
ここは載せ替えと直接関係がある部分ではないが、開発の中でメール周りのキャッチアップをしたので運用・保守の観点であらためて意識しなければいけないと感じた部分を記載。
とはいえ基本的な監視項目に関しては[PostmasterToolsのダッシュボード](https://support.google.com/a/answer/14668346?sjid=18116300461721221960-AP)に集約してくれているので、その後のアクションや何がどのように作用してこの結果になっているのか、という理解が大切になってくると感じる。

- エラー・バウンス率
3%以内を基準として、割合をキープしていく。
未達が続く場合にはソフトバウンス・ハードバウンス共にバウンズリストへ登録されるのでバウンズリストから原因を確認していく。
リストからの無闇な削除はSendGridの場合アカウント停止に繋がりうるので、適度なタイミングでのクリーニングを検討する必要あり。
また、APIキーの不正利用により高まる可能性もあるので、IP Access Managementの設定&確認は必要。

- IPレピュテーション
プロプランの場合、固定アドレスとなるため他のユーザーによってレピュテーションが下がっている可能性はない。
もちろん不正利用がなされていない状態でとなるので、IP制御の設定はこちらの観点でも重要。
レピュテーションには様々な要素があるので一概には難しいが、迷惑メール率・到達率に異常な変化がないか、他の指標と組み合わせながら異常の検知が必要。

- 固定IPアドレスの必要数
ユーザー増加に伴い、1日あたりのメール送信数が増加することによってIPアドレスを増やす対応が求められる。
上記のIPレピュテーションによって特定のIPアドレスから送信できる通数は異なるが、IPアドレスを増やす必要があるかは監視していく中で判断が必要。[こちら](https://twilio-cms-prod.s3.amazonaws.com/documents/Generic_IP_Warmup_Schedule.pdf)を参考に検討の予定。
その際には、マーケティングメールとトランザクションメールの分散も視野に入れる。
これはインボックスプロバイダのコネクション数・コネクション1つあたりの送信通数に制限があるようなので、メールの不達に繋がる。

- ドメインレピュテーション
こちらもIPレピュテーションと同様に他の指標と組み合わせながら監視していく必要はあり。
認証まわりはIPよりもドメインの方が影響を受けやすいので、それぞれの認証の成功率を見ていく。
とはいえ、postfix×OpenDKIM構成からは解放されたので認証の成功率に関してはSendgrid導入において問題なくキープされていくことを期待。

- 迷惑メール率
サービスの特性上、アンコントローラブルな部分が多く、直接的にこの指標を持って何かしらのアクションに繋げることは難しい。
とはいえ、他の指標によって影響を受ける部分であるので、結果として捉えていく形が最初は良いかもしれない。

## 移行していく上で困ったこと
- 認証まわりをSendgridに移行する形となったが、メールソース上SPF・DKIM・DMARC全てでPASSとなったものの、PostmasterToolsのダッシュボードではdkim&spfが「要対応」となってしまう事象に。Domain Authentication側でも全てVerifiedとなっているため、経過観察とした。
- ワンクリック解除のベストプラクティスに則り、メールヘッダにList-Unsubscribe-Post及びList-Unsubscribeの設定をするも、メーリングリストの登録解除ボタンが表示されない。Gmailコミュニティにある程度実績が積まれないと表示されないという[回答](https://support.google.com/mail/thread/49653586/list-unsubscribe-header-not-providing-the-option-to-unsubscribe?hl=en)もあったのでこちらも経過観察とし、本文内にリンクを設けておく対応とした。


## 振り返り（個人的なものも含め）
PostmasterToolsの監視項目でありつつも、まだ理解が浅いと感じるものが認識できた。最低限の基準は達成しているものの、こちらは引き続き学習を続けていく。
- 暗号化
- フィードバックループ

移行計画の精度が低かったと感じる。
リリース1週前になってIPウォームアップと送信先リストのクリーニングの観点から計画の変更が必要かどうか検討する流れとなってしまったので、他サービスの移行に関しても特に事故れない領域に関しては情報収集を予め厚めにしていくように。