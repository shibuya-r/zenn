---
title: "稼働中のアプリケーションをcdk&cfnスタックの管理下に置いた話"
emoji: "🚀"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["aws", "awscdk", "cloudformation"]
published: false
---

稼働して4年ほどのwebアプリケーションがあり、構成管理は部分的にterraformで行っているという状態のものを、一貫してcfnスタックの管理下に移行しました。

構成管理できていないアプリケーションをいくつかの段階を経て、少しずつ管理下に置いていった流れを振り返っていくので、これから同様の動きをしていこうとされている方の参考になれば幸いです。

規模感としては以下のようなイメージです。
- フロントエンド*2（CloudFront、ALB×ECS等）
- バックエンドAPI*4

## とりあえずのIaCジェネレータ！
cfnには既存リソースをスキャンし、cfnテンプレートの生成、CDKコンストラクトライブラリを利用したソースコードに変換することのできるIaCジェネレータという機能があります。

https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/generate-IaC.html

cfnテンプレートからCDKに載せる形になるのでL1コンストラクトを利用したコードになるのですが、構成管理のできていなかった部分も多くブラックボックスとなってしまっていたのでこちらを利用してみました。
いくつか課題を感じたので記載します。

:::message alert
2024/09あたりに実施した際の状態になりますので、既に挙動が変更されている可能性があります。
:::

### CDK deployが通る状態でCDKソースコードが生成されない
CfnLoadBalancerのloadBalancerAttributes、CfnTargetGroupのtargetGroupAttributesなどは生成された状態から不要な属性を削除したりする必要がありました。

### 再現性のある環境にならない
環境を複製しようと思った際に、addDependsOnで明示的に依存関係を示してあげないとdeployできないことは多々ありました。
このへんの再現性をもてない問題に関してはIaCのメリットを大きく損なうことにもなるのできついなと感じており、リファクタリングを兼ねてL2への移行を決意することになります。

## スタック定義の統一・L2への移行
IaCジェネレータからのCDKコード生成は、スキャンしたAWSリソースをサービス単位で一つのスタックとして管理するようにしていました。
つまりALBとECSで構成されるフロントエンドサービス、ECS単独で構築されるバックエンドAPIなど、アーキテクチャは一緒でもサービス単位で個別のスタックの定義がなされることになります。

L2コンストラクトへの移行をするにあたり、サービス単位のスタックではなく、構成に応じたスタック定義を共通のものとして用意して各サービスで利用することとしました。

IaCジェネレータでスキャンされたリソースをスタックに入れ漏れていて、スタック移行をしたら意図せず構成が変わってしまったということにならないように注意は必要かと思いますが、その場合はarnで参照するようになっているので、そこまで追えれば意図しない変更も発生させずスタックの移行ができるかなと思います。

## ネットワークリソースの構成管理
これまではアプリケーション層のリソースをスタックとして管理していましたが、VPC、Subnet、VPCEndpointといったネットワーク層のリソースもスタックで管理していきました。


## 恩恵