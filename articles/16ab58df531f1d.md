---
title: "DevinにGitHubActionsから実行したECS Execコマンドのエラーハンドリングを実装させてみた"
emoji: "⚠️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["aws", "githubactions", "ecs", "devin"]
published: false
---

Devinにやらしてみた記事になります。
AIエージェントの発達により「やってみた」系の記事から「やらせてみた」系の記事などの発信も増えそうですね。

Devinくん、CLI芸人になりがち。

## やらせてみたこと

Fargateコンテナに対し```ecs execute-command```を実行するGitHubActionsのワークフローがあります。
今回例に挙げるexecute-commandでは、Fargateコンテナ内に用意しているDBマイグレーションのコマンドを実行しますが、その実行結果によってGitHubActionsをハンドリングさせるようにしました。
マイグレーションの実行結果がエラーであれば、GitHubActionsの実行結果もエラーにさせる、というようなイメージです。

マイグレーションには、一般的なWEBアプリケーションフレームワークの標準機能となっているものを利用しています。

## Devinの生成したコード

```yaml
    # 事前処理
  - name: Run migration
    id: migration
    run: |
        # マイグレーションコマンドの出力をファイルに保存
        aws ecs execute-command \
        --cluster ${{env.clustor-name}} \
        --task ${{env.task-id}}  \
        --container ${{env.app-name}} \
        --interactive \
        --command "${{env.command}}" > migration_output.log 2>&1
        
        # ログファイルの内容を表示（デバッグ用）
        echo "マイグレーションコマンドの出力:"
        cat migration_output.log
    env:
        command : 
            # マイグレーションコマンド

    # マイグレーション出力のエラーチェック
  - name: Check migration output for errors
    id: error-check
    run: |
        # PDOExceptionの検出（大文字小文字を区別しない）
        if grep -i "PDOException" migration_output.log; then
            echo "::error::マイグレーションでPDOExceptionが検出されました"
            exit 1
        fi
        
        # その他のエラーパターンを検出（Noticeエラーは除外）
        if grep -i "Error" migration_output.log | grep -v "Notice Error: Undefined index: REQUEST_METHOD" | grep -v "notice: Notice.*Undefined index: REQUEST_METHOD"; then
            # Noticeエラーに関連するエラーでないか確認
            if ! grep -A 5 "Error" migration_output.log | grep -i "Notice.*Undefined index: REQUEST_METHOD" > /dev/null; then
                echo "::error::マイグレーションでエラーが検出されました"
                exit 1
            fi
        fi
        
        # Noticeエラーのみが検出された場合は成功として扱う
        if grep -i "Notice Error: Undefined index: REQUEST_METHOD" migration_output.log || grep -i "notice: Notice.*Undefined index: REQUEST_METHOD" migration_output.log; then
            echo "Noticeエラーのみが検出されました - 無視します"
        else
            echo "エラーは検出されませんでした"
        fi

    # マイグレーション実行結果の通知
  - name: Migration result notification
    if: always()
    run: |
        if [ "${{ steps.migration.outcome }}" == "success" ] && [ "${{ steps.error-check.outcome }}" == "success" ]; then
            echo "マイグレーションが正常に完了しました"
        elif [ "${{ steps.error-check.outcome }}" == "failure" ]; then
            echo "マイグレーションはエラーを含んでおり、失敗しました"
            exit 1
        else
            echo "マイグレーションプロセスが失敗しました"
            exit 1
        fi
```

## やりたいことは、まぁわかる

execute-commandの実行ログを一時ファイルとして出力し、grepしまくることによってエラーを検知してoutcomeで判定するようにする、という流れですね。
マイグレーションコマンドなのでPDOExceptionをエラーとして判断し、Notice Errorは無視する、というようなことをしています。
かなり力技感があり柔軟性もクソもないですが、他に良さそうな方法もパッと思い浮かばないのが正直なところです。

最初は```tee```コマンドでファイルへの書き込みをしていたのですが、なぜかコマンドの実行結果が途中までしか書き込まれないという事象に直面したので、そこだけは要注意かもしれません。

### 正常終了時の実行結果

![success](/images/16ab58df531f1d/success.png)

### エラー発生時の実行結果

![error](/images/16ab58df531f1d/error.png)


Migration result notificationのstep要らないような気も。。。😓

## まとめ
一応、最低限期待通りの挙動となりましたが、この出力に至るまで複数回のやり取りをDevinとしています。
細かくテストを回しながらフィードバックを与えてあげる必要があると感じますが、「やっときたいけど優先度が低くて後回しにしている」系のタスクがDevinにやらせることによって他タスクと並行で解消に向かえるのは嬉しいなと感じました。

AIフレンドリーな開発環境の構築やプロンプトだったり、さまざま工夫を重ねながらDevinと仲良く付き合っていきたいなと思いました。